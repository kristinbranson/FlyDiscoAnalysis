% running ReSaveMetadata
% edit logfiledir, logfilename, explist, changestruct

logfiledir = '/groups/branson/home/robiea/Projects_data/FlyDisco/FlyDiscoPipeline/MetadataFixes';
%%%CHANGE
logfilename = 'expdirs_wk8_metachanges_logofauto.csv';

logfile = fullfile(logfiledir,logfilename);

% save changes to logfile
fid2 = fopen(logfile,'a');

%% explist 
%%%CHANGE
rootdatadir = '/groups/branson/bransonlab/flydisco_data';
%testing - accidently did in reall data direct DATA NOT PROTECTED PROPERLY
% explist = {'VNC_JHS_K_85321_RigA_20210322T164447'};
% wk5
% explist  = {'VNC_EXT_VGLUT-GAL4_RigD_20210420T142706', ...
% 'VNC_JRC_SS50975_RigD_20210420T130327', ...
% 'VNC_JRC_SS51901_RigD_20210420T131534', ...
% 'VNC_JRC_SS51902_RigD_20210420T153114', ...
% 'VNC_JRC_SS59198_RigD_20210420T133940', ...
% 'VNC_JRC_SS60231_RigD_20210420T135100', ...
% 'VNC_JRC_SS60234_RigD_20210420T140255', ...
% 'VNC_JRC_SS60240_RigD_20210420T141455', ...
% 'VNC_JRC_SS60246_RigD_20210420T154237', ...
% 'VNC_JRC_SS60632_RigD_20210420T144027', ...
% 'VNC_JRC_SS61066_RigD_20210420T145159', ...
% 'VNC_JRC_SS64190_RigD_20210420T150349', ...
% 'VNC_JRC_SS68333_RigD_20210420T151651', ...
% 'VNC_YNA_K_162984_RigD_20210420T132759'};
% wk4 
% explist = {'VNC_JRC_SS42744_RigB_20210412T131256', ...
% 'VNC_JRC_SS42744_RigD_20210412T131619', ...
% 'VNC_JRC_SS42749_RigB_20210412T132453', ...
% 'VNC_JRC_SS42749_RigD_20210412T132840', ...
% 'VNC_JRC_SS43522_RigB_20210412T133544', ...
% 'VNC_JRC_SS43522_RigD_20210412T133928', ...
% 'VNC_YNA_K_162984_RigB_20210412T134611', ...
% 'VNC_YNA_K_162984_RigD_20210412T134955', ...
% 'VNC_JRC_SS43660_RigB_20210412T140638', ...
% 'VNC_YNA_K_162984_RigD_20210412T140925', ...
% 'VNC_JHS_K_85321_RigB_20210412T141714', ...
% 'VNC_JHS_K_85321_RigD_20210412T142045', ...
% 'VNC_JRC_SS43679_RigB_20210412T142951', ...
% 'VNC_JRC_SS43679_RigD_20210412T143253', ...
% 'VNC_JRC_SS43679_RigB_20210412T144048', ...
% 'VNC_JRC_SS44256_RigB_20210412T145129', ...
% 'VNC_JRC_SS43700_RigD_20210412T145216', ...
% 'VNC_JRC_SS44256_RigD_20210412T150633', ...
% 'VNC_JRC_SS44261_RigB_20210412T151441', ...
% 'VNC_JRC_SS44261_RigD_20210412T151735', ...
% 'VNC_JRC_SS44268_RigB_20210412T152252', ...
% 'VNC_JRC_SS44268_RigD_20210412T152629', ...
% 'VNC_EXT_VGLUT-GAL4_RigB_20210412T153301', ...
% 'VNC_EXT_VGLUT-GAL4_RigD_20210412T153627'};
%wk1 
% explist = {'VNC_JRC_SS33475_RigA_20210325T133313'};
%wk4
% explist = {'VNC_YNA_K_162984_RigD_20210412T140925'};
% explist = {'VNC_JRC_SS43679_RigB_20210412T144048'};
%wk5
% explist = {'VNC_JRC_SS60240_RigD_20210422T142345'};
%wk6
% explist = {'VNC_JRC_SS40503_RigD_20210426T145817'};
% typos in line name
% explist = {'VNC_JRC_SS36194_RigD_20210426T145817'};
% explist = {'VNC_EXT_VGLUT-GAL4_RigD_20210429T141627'};
%wk7
% explist = {'VNC_JRC_SS67423_RigA_20210503T125834', ...
% 'VNC_JRC_SS40663_RigA_20210503T130638', ...
% 'VNC_JRC_SS59209_RigA_20210503T131510', ...
% 'VNC_JRC_SS59204_RigA_20210503T133115', ...
% 'VNC_JRC_SS59163_RigA_20210503T134106', ...
% 'VNC_JRC_SS57983_RigA_20210503T135803', ...
% 'VNC_JRC_SS57939_RigA_20210503T140813', ...
% 'VNC_JRC_SS53890_RigA_20210503T141709', ...
% 'VNC_YNA_K_162984_RigA_20210503T143637', ...
% 'VNC_JRC_SS64188_RigA_20210503T145015', ...
% 'VNC_EXT_VGLUT-GAL4_RigA_20210503T150117', ...
% 'VNC_JRC_SS67451_RigA_20210503T151211', ...
% 'VNC_JRC_SS52985_RigA_20210503T152107', ...
% 'VNC_JRC_SS42702_RigA_20210503T153313'};
% explist = {'VNC_JRC_SS40663_RigD_20210503T132030'};
% explist = {'VNC_JRC_SS57939_RigD_20210505T134338'};
% explist = {'VNC_JRC_SS57939_RigD_20210505T135215'};
%wk8
% explist = {'VNC_JRC_SS45388_RigA_20210510T125529', ...
% 'VNC_JRC_SS46301_RigA_20210510T130428', ...
% 'VNC_JRC_SS46706_RigA_20210510T131259', ...
% 'VNC_JRC_SS49182_RigA_20210510T132957', ...
% 'VNC_JRC_SS50632_RigA_20210510T133758', ...
% 'VNC_JRC_SS50955_RigA_20210510T134626', ...
% 'VNC_JRC_SS51895_RigA_20210510T135509', ...
% 'VNC_JRC_SS57967_RigA_20210510T141347', ...
% 'VNC_JRC_SS57969_RigA_20210510T142145', ...
% 'VNC_JRC_SS57979_RigA_20210510T143004', ...
% 'VNC_JRC_SS59229_RigA_20210510T143822', ...
% 'VNC_JRC_SS60614_RigA_20210510T144747', ...
% 'VNC_EXT_VGLUT-GAL4_RigA_20210510T145544', ...
% 'VNC_YNA_K_162984_RigA_20210510T150352'};
explist = {'VNC_JRC_SS70461_RigA_20210511T150909'};
for j = 1:numel(explist)
    % per experiment
    expdir = fullfile(rootdatadir,explist{j})
    metadatafilename = 'Metadata.xml';
    resavefilename = fullfile(expdir,metadatafilename);
    metadata = ReadMetadataFile(resavefilename);
    
    %%%CHANGE
    % manual changes create struct
    changestruct = struct;
%         changestruct.experimenter = 'chenn';
    % also need to change expdir and ctrax results movie name manually
    % mv oldname newname
    %     changestruct.line = 'JRC_SS43660';
    %     changestruct.line = 'JRC_SS43700';
    %     changestruct.line = 'EXT_VGLUT-GAL4';
    %     changestruct.line = 'JRC_SS36194';
    %     changestruct.line = 'YNA_K_162984';
%     changestruct.line = 'JRC59209';
%     changestruct.line = 'JRC_SS57983';
%     changestruct.line = 'JRC_SS59163';
    changestruct.line = 'JRC_SS62883';
    
    % replace metadata fields with changes
    fprintf(fid2,'%s, ',expdir);
    metadatafieldsTOBECHANGED = fieldnames(changestruct);
    metadatafields = fieldnames(metadata);
    for i = 1:numel(metadatafieldsTOBECHANGED)
        if isnumeric(changestruct.(metadatafieldsTOBECHANGED{i})) && isnumeric(metadata.(metadatafieldsTOBECHANGED{i}))
            fprintf(fid2,'%s,%d,%d,',(metadatafieldsTOBECHANGED{i}),metadata.(metadatafieldsTOBECHANGED{i}),changestruct.(metadatafieldsTOBECHANGED{i}));
            metadata.(metadatafieldsTOBECHANGED{i}) = changestruct.(metadatafieldsTOBECHANGED{i});
        else
            fprintf(fid2,'%s,%s,%s,',(metadatafieldsTOBECHANGED{i}),metadata.(metadatafieldsTOBECHANGED{i}),changestruct.(metadatafieldsTOBECHANGED{i}));
            metadata.(metadatafieldsTOBECHANGED{i}) = changestruct.(metadatafieldsTOBECHANGED{i});
        end
    end
    fprintf(fid2,'\n');
    
    % resave metadata and backup   
    [success] = ResaveMetadata(metadata,resavefilename);
    
end

fclose(fid2);
