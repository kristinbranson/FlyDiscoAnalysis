% running ReSaveMetadata
% edit logfiledir, logfilename, explist, changestruct

logfiledir = '/groups/branson/home/robiea/Projects_data/FlyDisco/FlyDiscoPipeline/MetadataFixes';
%%%CHANGE
logfilename = 'expdirs_changescreen_type4labnameerror_logofauto.csv';

logfile = fullfile(logfiledir,logfilename);

% save changes to logfile
fid2 = fopen(logfile,'a');

%% explist
%%%CHANGE
% rootdatadir = '/groups/dickson/dicksonlab/flydisco_data';

%testing - accidently did in reall data direct DATA NOT PROTECTED PROPERLY
% explist = {'VNC_JHS_K_85321_RigA_20210322T164447'};
% wk5
% explist  = {'VNC_EXT_VGLUT-GAL4_RigD_20210420T142706', ...
% 'VNC_JRC_SS50975_RigD_20210420T130327', ...
% 'VNC_JRC_SS51901_RigD_20210420T131534', ...
% 'VNC_JRC_SS51902_RigD_20210420T153114', ...
% 'VNC_JRC_SS59198_RigD_20210420T133940', ...
% 'VNC_JRC_SS60231_RigD_20210420T135100', ...
% 'VNC_JRC_SS60234_RigD_20210420T140255', ...
% 'VNC_JRC_SS60240_RigD_20210420T141455', ...
% 'VNC_JRC_SS60246_RigD_20210420T154237', ...
% 'VNC_JRC_SS60632_RigD_20210420T144027', ...
% 'VNC_JRC_SS61066_RigD_20210420T145159', ...
% 'VNC_JRC_SS64190_RigD_20210420T150349', ...
% 'VNC_JRC_SS68333_RigD_20210420T151651', ...
% 'VNC_YNA_K_162984_RigD_20210420T132759'};
% wk4
% explist = {'VNC_JRC_SS42744_RigB_20210412T131256', ...
% 'VNC_JRC_SS42744_RigD_20210412T131619', ...
% 'VNC_JRC_SS42749_RigB_20210412T132453', ...
% 'VNC_JRC_SS42749_RigD_20210412T132840', ...
% 'VNC_JRC_SS43522_RigB_20210412T133544', ...
% 'VNC_JRC_SS43522_RigD_20210412T133928', ...
% 'VNC_YNA_K_162984_RigB_20210412T134611', ...
% 'VNC_YNA_K_162984_RigD_20210412T134955', ...
% 'VNC_JRC_SS43660_RigB_20210412T140638', ...
% 'VNC_YNA_K_162984_RigD_20210412T140925', ...
% 'VNC_JHS_K_85321_RigB_20210412T141714', ...
% 'VNC_JHS_K_85321_RigD_20210412T142045', ...
% 'VNC_JRC_SS43679_RigB_20210412T142951', ...
% 'VNC_JRC_SS43679_RigD_20210412T143253', ...
% 'VNC_JRC_SS43679_RigB_20210412T144048', ...
% 'VNC_JRC_SS44256_RigB_20210412T145129', ...
% 'VNC_JRC_SS43700_RigD_20210412T145216', ...
% 'VNC_JRC_SS44256_RigD_20210412T150633', ...
% 'VNC_JRC_SS44261_RigB_20210412T151441', ...
% 'VNC_JRC_SS44261_RigD_20210412T151735', ...
% 'VNC_JRC_SS44268_RigB_20210412T152252', ...
% 'VNC_JRC_SS44268_RigD_20210412T152629', ...
% 'VNC_EXT_VGLUT-GAL4_RigB_20210412T153301', ...
% 'VNC_EXT_VGLUT-GAL4_RigD_20210412T153627'};
%wk1
% explist = {'VNC_JRC_SS33475_RigA_20210325T133313'};
%wk4
% explist = {'VNC_YNA_K_162984_RigD_20210412T140925'};
% explist = {'VNC_JRC_SS43679_RigB_20210412T144048'};
%wk5
% explist = {'VNC_JRC_SS60240_RigD_20210422T142345'};
%wk6
% explist = {'VNC_JRC_SS40503_RigD_20210426T145817'};
% typos in line name
% explist = {'VNC_JRC_SS36194_RigD_20210426T145817'};
% explist = {'VNC_EXT_VGLUT-GAL4_RigD_20210429T141627'};
%wk7
% explist = {'VNC_JRC_SS67423_RigA_20210503T125834', ...
% 'VNC_JRC_SS40663_RigA_20210503T130638', ...
% 'VNC_JRC_SS59209_RigA_20210503T131510', ...
% 'VNC_JRC_SS59204_RigA_20210503T133115', ...
% 'VNC_JRC_SS59163_RigA_20210503T134106', ...
% 'VNC_JRC_SS57983_RigA_20210503T135803', ...
% 'VNC_JRC_SS57939_RigA_20210503T140813', ...
% 'VNC_JRC_SS53890_RigA_20210503T141709', ...
% 'VNC_YNA_K_162984_RigA_20210503T143637', ...
% 'VNC_JRC_SS64188_RigA_20210503T145015', ...
% 'VNC_EXT_VGLUT-GAL4_RigA_20210503T150117', ...
% 'VNC_JRC_SS67451_RigA_20210503T151211', ...
% 'VNC_JRC_SS52985_RigA_20210503T152107', ...
% 'VNC_JRC_SS42702_RigA_20210503T153313'};
% explist = {'VNC_JRC_SS40663_RigD_20210503T132030'};
% explist = {'VNC_JRC_SS57939_RigD_20210505T134338'};
% explist = {'VNC_JRC_SS57939_RigD_20210505T135215'};
%wk8
% explist = {'VNC_JRC_SS45388_RigA_20210510T125529', ...
% 'VNC_JRC_SS46301_RigA_20210510T130428', ...
% 'VNC_JRC_SS46706_RigA_20210510T131259', ...
% 'VNC_JRC_SS49182_RigA_20210510T132957', ...
% 'VNC_JRC_SS50632_RigA_20210510T133758', ...
% 'VNC_JRC_SS50955_RigA_20210510T134626', ...
% 'VNC_JRC_SS51895_RigA_20210510T135509', ...
% 'VNC_JRC_SS57967_RigA_20210510T141347', ...
% 'VNC_JRC_SS57969_RigA_20210510T142145', ...
% 'VNC_JRC_SS57979_RigA_20210510T143004', ...
% 'VNC_JRC_SS59229_RigA_20210510T143822', ...
% 'VNC_JRC_SS60614_RigA_20210510T144747', ...
% 'VNC_EXT_VGLUT-GAL4_RigA_20210510T145544', ...
% 'VNC_YNA_K_162984_RigA_20210510T150352'};
% explist = {'VNC_JRC_SS70461_RigA_20210511T150909'};
%wk9
% explist = {'VNC_w1118_RigA_20210517T160548', ...
% 'VNC_w1118_RigB_20210517T160504', ...
% 'VNC_w1118_RigC_20210517T160718', ...
% 'VNC_w1118_RigD_20210517T161012'};
% explist = {'VNC_JRC_SS50974_RigD_20210519T151055'};
% wk10
% % chenn to arrudar
% explist = {'VNC_JRC_SS50325_RigB_20210526T131511', ...
% 'VNC_JRC_SS51006_RigB_20210526T133023', ...
% 'VNC_JRC_SS51800_RigB_20210526T134822', ...
% 'VNC_JRC_SS51827_RigB_20210526T135715', ...
% 'VNC_JRC_SS53050_RigB_20210526T141102', ...
% 'VNC_JRC_SS59153_RigB_20210526T142406', ...
% 'VNC_JRC_SS59180_RigB_20210526T144330', ...
% 'VNC_JRC_SS59225_RigB_20210526T145516'};
% arrudar to chenn
% explist = {'VNC_JRC_SS39347_RigA_20210524T131330', ...
% 'VNC_JRC_SS50325_RigA_20210524T134333', ...
% 'VNC_JRC_SS51006_RigA_20210524T135504', ...
% 'VNC_JRC_SS51800_RigA_20210524T140426', ...
% 'VNC_JRC_SS51827_RigA_20210524T141336', ...
% 'VNC_JRC_SS53050_RigA_20210524T142133', ...
% 'VNC_JRC_SS59153_RigA_20210524T144120', ...
% 'VNC_JRC_SS59180_RigA_20210524T144924', ...
% 'VNC_JRC_SS59225_RigA_20210524T145900', ...
% 'VNC_JRC_SS60232_RigA_20210524T150825', ...
% 'VNC_JRC_SS60236_RigA_20210524T151718', ...
% 'VNC_JRC_SS60618_RigA_20210524T152614', ...
% 'VNC_YNA_K_162984_RigA_20210524T153512', ...
% 'VNC_EXT_VGLUT-GAL4_RigA_20210524T154402'};
% change line name to JRC_SS53050
% explist = {'VNC_JRC_SS51827_RigA_20210526T141149'};
% change line name to JRC_SS66932
% explist = {'VNC_JRC_SS68266_RigD_20210525T153528'};
%change line name to JRC_SS67903
% explist = {'VNC_JRC_SS67372_RigC_20210527T153618'};
% robot stock copy errors in new metadata file char to num prob
% explist = {'VNC_EXT_VGLUT-GAL4_RigD_20210517T161012', ...
% 'VNC_EXT_VGLUT-GAL4_RigC_20210517T160718', ...
% 'VNC_EXT_VGLUT-GAL4_RigB_20210517T160504', ...
% 'VNC_EXT_VGLUT-GAL4_RigA_20210517T160548'};
% june reruns wk 12,13,14
% change minegishir to arrudar
% explist = {'VNC_JRC_SS31881_RigB_20210614T130008', ...
% 'VNC_JRC_SS61813_RigB_20210614T130800', ...
% 'VNC_JRC_SS25466_RigB_20210614T131609', ...
% 'VNC_JRC_SS29662_RigB_20210614T132354', ...
% 'VNC_JRC_SS29892_RigB_20210614T133248'};

% change screen_type for experiments with 0212 led protocol to 'non_olympiad_dickson_led5secVNC'
% % explist = textread('/groups/branson/home/robiea/Projects_data/FlyDisco/FlyDiscoPipeline/expdirlist_0212ledprotocol.txt','%s');

% fix experiments screen_type for expdirs where i had a type in the file
% name (introduced a space when manually fixing expdir due to linename
% changes) 
% explist = {'/groups/branson/bransonlab/flydisco_data/VNC_EXT_VGLUT-GAL4_RigB_20210323T132431', ...
%     '/groups/branson/bransonlab/flydisco_data/VNC_EXT_VGLUT-GAL4_RigC_20210323T132625', ...
%     '/groups/branson/bransonlab/flydisco_data/VNC_EXT_VGLUT-GAL4_RigD_20210323T132726'};

% redo experiments with bad metadata files after screen_type changed for
% older led protocol - appending updates to the same csv file 

% expnamelist = textread('/groups/branson/home/robiea/Projects_data/FlyDisco/FlyDiscoPipeline/malformedmetadataexplist_bransonlab.txt','%s');
% rootdatadir = '/groups/branson/bransonlab/flydisco_data';
% for k =1:numel(expnamelist)
%     explist{k} = fullfile(rootdatadir,expnamelist{k});
% end

% change lab and screen_type for 9/21-22 experiments recorded with
% labname = branson and instead of dickson
explist = textread('/groups/branson/home/robiea/Projects_data/FlyDisco/FlyDiscoPipeline/MetadataFixes/expdirlist_wk_fix_labname.txt','%s');
% test explist = {'/groups/branson/home/robiea/Projects_data/FlyDisco/Bubble_data/20210928_testscreen_typerename/VNC_EXT_VGLUT-GAL4_RigA_20210921T144604'};


% values to change in metadata
for j = 1:numel(explist)
    % per experiment
    %     expdir = fullfile(rootdatadir,explist{j})
    expdir = explist{j};
    metadatafilename = 'Metadata.xml';
    
    resavefilename = fullfile(expdir,metadatafilename);
    metadata = ReadMetadataFile(resavefilename);
    
    %%%CHANGE
    % manual changes create struct
    changestruct = struct;
    %         changestruct.experimenter = 'chenn';
    % changestruct.experimenter = 'arrudar';
    %       changestruct.plate = '4a';
    % also need to change expdir and ctrax results movie name manually
    % mv oldname newname
    %     changestruct.line = 'JRC_SS43660';
    %     changestruct.line = 'JRC_SS43700';
    %     changestruct.line = 'EXT_VGLUT-GAL4';
    %     changestruct.line = 'JRC_SS36194';
    %     changestruct.line = 'YNA_K_162984';
    %     changestruct.line = 'JRC59209';
    %     changestruct.line = 'JRC_SS57983';
    %     changestruct.line = 'JRC_SS59163';
    %     changestruct.line = 'JRC_SS62883';
    %     changestruct.line = 'EXT_VGLUT-GAL4';
    %     changestruct.line = 'JRC_SS53050';
    %     changestruct.line = 'JRC_SS66932';
    %     changestruct.line = 'JRC_SS67903';
%     changestruct.screen_type = 'non_olympiad_dickson_led5secVNC';
    changestruct.lab = 'dickson';
    changestruct.screen_type = 'non_olympiad_dickson_VNC';
    
    % replace metadata fields with changes
    fprintf(fid2,'%s, ',expdir);
    metadatafieldsTOBECHANGED = fieldnames(changestruct);
    metadatafields = fieldnames(metadata);
    for i = 1:numel(metadatafieldsTOBECHANGED)
        if isnumeric(changestruct.(metadatafieldsTOBECHANGED{i})) && isnumeric(metadata.(metadatafieldsTOBECHANGED{i}))
            fprintf(fid2,'%s,%d,%d,',(metadatafieldsTOBECHANGED{i}),metadata.(metadatafieldsTOBECHANGED{i}),changestruct.(metadatafieldsTOBECHANGED{i}));
            metadata.(metadatafieldsTOBECHANGED{i}) = changestruct.(metadatafieldsTOBECHANGED{i});
        else
            fprintf(fid2,'%s,%s,%s,',(metadatafieldsTOBECHANGED{i}),metadata.(metadatafieldsTOBECHANGED{i}),changestruct.(metadatafieldsTOBECHANGED{i}));
            metadata.(metadatafieldsTOBECHANGED{i}) = changestruct.(metadatafieldsTOBECHANGED{i});
        end
    end
    
    
    % resave metadata and backup
    [success] = ResaveMetadata(metadata,resavefilename);
    if ~success
        fprintf(fid2,'failed to write readable metadata file');
    end
    fprintf(fid2,'\n');
end

fclose(fid2);
